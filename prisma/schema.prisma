generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String    @id @default(cuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @default(now())
  deleted_at DateTime?

  // Account status & approval
  status      UserStatus @default(DEACTIVATED)
  approved_at DateTime?
  approved_by String? // admin user id who approved

  // Auth & identity
  email    String? @unique
  username String? @unique
  password String? @db.VarChar(255)

  // Profile
  name       String? @db.VarChar(255)
  first_name String? @db.VarChar(255)
  last_name  String? @db.VarChar(255)
  avatar     String?

  // Timezone (from settings screen)
  timezone String? @default("UTC")

  role              Role      @default(AUTHORIZED_VIEWER)
  email_verified_at DateTime?

  // Merged from Ucode — password reset / email verification tokens
  password_reset_token          String?
  password_reset_expires_at     DateTime?
  password_reset_otp            String? // hashed OTP
  password_reset_otp_expires_at DateTime? // OTP expiry (short ~10min)
  password_reset_verified_at    DateTime?

  // Access expiration (admin-controlled per user)
  access_expires_at DateTime?
  access_revoked_at DateTime?
  access_revoked_by String? // admin user id who revoked

  // soft delete flag
  isDeleted Boolean @default(false)

  // ── Personal Notification Preferences 
  // Property Manager (role = PROPERTY_MANAGER)
  notif_pm_new_property_dashboard_assigned   Boolean @default(true)
  notif_pm_property_dashboard_access_request Boolean @default(true)
  notif_pm_property_dashboard_update         Boolean @default(true)

  // Authorized Viewer (role = AUTHORIZED_VIEWER)
  notif_av_new_property_dashboard_invitation Boolean @default(true)
  notif_av_access_request_update             Boolean @default(true)
  notif_av_property_dashboard_update         Boolean @default(true)

  // Operational Team (role = OPERATIONAL_TEAM)
  notif_ot_new_inspection_assigned      Boolean @default(true)
  notif_ot_due_inspection               Boolean @default(true)
  notif_ot_incomplete_inspection_report Boolean @default(true)

  // Admin personal notifications (role = ADMIN)
  notif_admin_new_user_registration        Boolean @default(true)
  notif_admin_due_inspection               Boolean @default(true)
  notif_admin_new_inspection_report_update Boolean @default(true)

  // Relations
  receiver_notifications Notification[] @relation("receiver")
  sender_notifications   Notification[] @relation("sender")

  managedProperties Property[]   @relation("PropertyManager")
  inspections       Inspection[]

  // Audit: actions performed by this user
  audit_logs AuditLog[]

  propertyAccesses PropertyAccess[]        @relation("PropertyAccesses")
  accessRequests   PropertyAccessRequest[] @relation("AccessRequests")
  reviewedRequests PropertyAccessRequest[] @relation("ReviewedRequests")

  @@map("users")
}

// ─────────────────────────────────────────
// INSPECTION CRITERIA (Pillar 1)
// ─────────────────────────────────────────

model InspectionCriteria {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // The input fields shown at top of inspection form
  // e.g. Property Name, Date, Inspector, Roof System Type
  headerFields Json
  // Example:
  // [
  //   { "key": "inspectionTitle", "label": "Inspection Title", "type": "text", "required": true },
  //   { "key": "propertyType",    "label": "Property Type",    "type": "dropdown",
  //     "options": ["Commercial","Residential"], "required": false },
  //   { "key": "roofSystemType",  "label": "Roof System Type", "type": "dropdown",
  //     "options": ["TPO","Metal","Shingle"], "required": false },
  //   { "key": "drainageType",    "label": "Drainage Type",    "type": "dropdown",
  //     "options": ["Internal","External"], "required": false }
  // ]

  // The scored categories shown in checklist
  // e.g. Surface Condition (25pts), Seams & Flashings (20pts)
  scoringCategories Json
  // Example:
  // [
  //   { "key": "surfaceCondition",  "label": "Surface Condition",       "maxPoints": 25 },
  //   { "key": "seamsFlashings",    "label": "Seams & Flashings",       "maxPoints": 20 },
  //   { "key": "drainagePonding",   "label": "Drainage & Ponding",      "maxPoints": 15 },
  //   { "key": "penetrations",      "label": "Penetrations & Accessories", "maxPoints": 10 },
  //   { "key": "repairsHistory",    "label": "Repairs & Patch History", "maxPoints": 10 },
  //   { "key": "ageExpectedLife",   "label": "Age vs. Expected Life",   "maxPoints": 10 }
  // ]

  // Media & document input slots shown in the Media Files tab
  // type: "file" = upload widget | "embed" = text/iframe input | "document" = doc upload
  mediaFields Json
  // Example:
  // [
  //   { "key": "mediaFiles",  "label": "Media Files", "placeholder": "Upload Media file",
  //     "type": "file",     "isSystem": true, "order": 1, "accept": ["image/*","video/*"] },
  //   { "key": "aerialMap",  "label": "Aerial Map",  "placeholder": "Upload your file.",
  //     "type": "file",     "isSystem": true, "order": 2, "accept": ["image/*"] },
  //   { "key": "tour3d",     "label": "3D Tours",    "placeholder": "Paste Source URL / iframe Code",
  //     "type": "embed",    "isSystem": true, "order": 3 },
  //   { "key": "documents",  "label": "Documents",   "placeholder": "Add Documents",
  //     "type": "document", "isSystem": true, "order": 4 }
  // ]

  templates DashboardTemplate[]

  @@map("inspection_criteria")
}

// ─────────────────────────────────────────
// DASHBOARD TEMPLATE (Pillar 2)
// ─────────────────────────────────────────

model DashboardTemplate {
  id         String         @id @default(cuid())
  name       String
  status     TemplateStatus @default(ACTIVE)
  criteriaId String
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Layout sections — what blocks appear on the dashboard
  sections Json
  // Example:
  // [
  //   { "order": 1, "type": "header_info",      "label": "Property Info",         "config": {} },
  //   { "order": 2, "type": "health_snapshot",  "label": "Roof Health Snapshot",  "config": {} },
  //   { "order": 3, "type": "media_grid",       "label": "Media Files",           "config": {} },
  //   { "order": 4, "type": "aerial_map",       "label": "Aerial Map",            "config": {} },
  //   { "order": 5, "type": "tour_3d",          "label": "3D Roof Tour",          "config": {} },
  //   { "order": 6, "type": "repair_planning",  "label": "Priority Repair Planning", "config": {} },
  //   { "order": 7, "type": "documents",        "label": "Documents",             "config": {} },
  //   { "order": 8, "type": "additional_info",  "label": "Additional Information","config": {} }
  // ]

  criteria   InspectionCriteria @relation(fields: [criteriaId], references: [id])
  properties Property[]

  @@map("dashboard_templates")
}

// ─────────────────────────────────────────
// PROPERTY (Pillar 3) ← your form creates this
// ─────────────────────────────────────────

model Property {
  id String @id @default(cuid())

  // ── From your "Create New Property Dashboard" form ──
  name               String // "Property Name *"
  address            String // "Address *"
  propertyType       String? // "Property Type" dropdown
  nextInspectionDate DateTime? // "Next Inspection" date picker
  propertyManagerId  String? // "Assign Property Manager" dropdown
  // ────────────────────────────────────────────────────

  activeTemplateId String?
  status           PropertyStatus @default(ACTIVE)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  propertyManager User?                   @relation("PropertyManager", fields: [propertyManagerId], references: [id])
  activeTemplate  DashboardTemplate?      @relation(fields: [activeTemplateId], references: [id])
  dashboard       PropertyDashboard?
  auditLogs       AuditLog[]
  accesses        PropertyAccess[]
  accessRequests  PropertyAccessRequest[]

  @@map("properties")
}

// ─────────────────────────────────────────
// PROPERTY DASHBOARD (Pillar 4)
// ─────────────────────────────────────────

model PropertyDashboard {
  id         String @id @default(cuid())
  propertyId String @unique // one dashboard per property
  templateId String

  // Frozen copy of template.sections at creation time
  // so editing the template later never breaks this dashboard
  templateSnapshot Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  property    Property     @relation(fields: [propertyId], references: [id])
  inspections Inspection[]
  documents   Document[]
  auditLogs   AuditLog[]

  @@map("property_dashboards")
}

// ─────────────────────────────────────────
// INSPECTION (Pillar 5)
// ─────────────────────────────────────────

model Inspection {
  id          String           @id @default(cuid())
  dashboardId String
  inspectorId String
  status      InspectionStatus @default(DRAFT)

  // Filled header fields (matches criteria.headerFields keys)
  // { "inspectionTitle": "2024 Annual Roof Inspection", "roofSystemType": "Metal", ... }
  headerData Json

  // Filled scores per category (matches criteria.scoringCategories keys)
  // { "surfaceCondition": { "score": 22, "notes": "Minor cracks observed" },
  //   "seamsFlashings":   { "score": 18, "notes": "Good overall" }, ... }
  scores Json

  // Computed from scores
  overallScore  Float?
  healthLabel   String? // "Good" | "Fair" | "Poor"
  remainingLife String? // "5-7 Years"

  // Repair items shown in Priority Repair Planning section
  repairItems Json
  // [
  //   { "title": "Emergency Leak Repair", "priority": "urgent",
  //     "description": "Moisture stains / vulnerable joints noted..." },
  //   { "title": "Metal Panel Corrosion", "priority": "maintenance",  "description": "..." },
  //   { "title": "Metal Panel Corrosion", "priority": "replacement_planning", "description": "..." }
  // ]

  aerialMapUrl String?
  tourUrl      String?

  // NTE and additional comments (Additional Information section)
  nteValue           Float?
  additionalComments String?

  inspectedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dashboard  PropertyDashboard @relation(fields: [dashboardId], references: [id])
  inspector  User              @relation(fields: [inspectorId], references: [id])
  mediaFiles MediaFile[]

  @@map("inspections")
}

model PropertyAccess {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId String
  userId     String

  grantedBy String // admin or PM user id who approved
  grantedAt DateTime @default(now())

  // Time-limited access (for insurers, consultants, etc.)
  expiresAt DateTime?

  // Revocation
  revokedAt DateTime?
  revokedBy String?

  // Relations
  property Property @relation(fields: [propertyId], references: [id])
  user     User     @relation("PropertyAccesses", fields: [userId], references: [id])

  @@unique([propertyId, userId]) // one row per property+user
  @@map("property_accesses")
}

// ── Model 2: Access request lifecycle ────────────────────────────────────────
//
// Created when an Authorized Viewer clicks "Request Access".
// Drives the notification shown to the Property Manager.
// Once approved → a PropertyAccess row is created automatically.

model PropertyAccessRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  propertyId  String
  requesterId String // the Authorized Viewer who clicked "Request Access"

  status AccessRequestStatus @default(PENDING)

  // Set when PM/Admin acts on the request
  reviewedBy String?
  reviewedAt DateTime?

  // Relations
  property  Property @relation(fields: [propertyId], references: [id])
  requester User     @relation("AccessRequests", fields: [requesterId], references: [id])
  reviewer  User?    @relation("ReviewedRequests", fields: [reviewedBy], references: [id])

  @@unique([propertyId, requesterId]) // one pending request per property+user
  @@map("property_access_requests")
}

// ─────────────────────────────────────────
// MEDIA FILES
// ─────────────────────────────────────────

model MediaFile {
  id           String    @id @default(cuid())
  inspectionId String
  dashboardId  String?
  fileName     String
  fileType     MediaType
  url          String
  category     String? // "photo" | "aerial" | "tour" | "video"
  size         Int? // bytes
  version      Int       @default(1)
  isArchived   Boolean   @default(false)
  uploadedAt   DateTime  @default(now())

  inspection Inspection @relation(fields: [inspectionId], references: [id])

  @@map("media_files")
}

// ─────────────────────────────────────────
// DOCUMENTS
// ─────────────────────────────────────────

model Document {
  id          String   @id @default(cuid())
  dashboardId String
  name        String
  url         String
  fileSize    Int?
  version     Int      @default(1)
  isArchived  Boolean  @default(false)
  uploadedAt  DateTime @default(now())

  dashboard PropertyDashboard @relation(fields: [dashboardId], references: [id])
  auditLogs AuditLog[]

  @@map("documents")
}

model AuditLog {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())

  // Who did it
  user_id String?
  user    User?   @relation(fields: [user_id], references: [id])

  // What was affected
  property_id String?
  property    Property? @relation(fields: [property_id], references: [id])
  document_id String?
  document    Document? @relation(fields: [document_id], references: [id])

  // What happened
  // e.g. "file_upload" | "status_update" | "user_access_granted" | "user_access_revoked" | "login" | "password_reset"
  action      String?
  entity_type String? // "user" | "property" | "document"
  entity_id   String?

  // Snapshot of changes (JSON diff)
  metadata           Json?
  propertyDashboards PropertyDashboard[]

  @@map("audit_logs")
}

model NotificationEvent {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  status Int?    @default(1) @db.SmallInt
  // e.g. "new_access_request" | "access_approved" | "access_denied" | "dashboard_update" | "new_upload" | "access_expiring_soon"
  type   String?
  text   String?

  notifications Notification[]

  @@map("notification_events")
}

model Notification {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  read_at DateTime?
  status  Int?      @default(1) @db.SmallInt

  sender_id String?
  sender    User?   @relation("sender", fields: [sender_id], references: [id])

  receiver_id String?
  receiver    User?   @relation("receiver", fields: [receiver_id], references: [id])

  notification_event_id String?
  notification_event    NotificationEvent? @relation(fields: [notification_event_id], references: [id])

  entity_id String?

  @@map("notifications")
}

model UserLevelNotificationSettings {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  updated_by String? // admin user id who last changed this

  // Property Manager defaults
  pm_new_property_dashboard_assigned   Boolean @default(true)
  pm_property_dashboard_access_request Boolean @default(true)
  pm_property_dashboard_update         Boolean @default(true)

  // Authorized Viewer defaults
  av_new_property_dashboard_invitation Boolean @default(true)
  av_access_request_update             Boolean @default(true)
  av_property_dashboard_update         Boolean @default(true)

  // Operational Team defaults
  ot_new_inspection_assigned      Boolean @default(true)
  ot_due_inspection               Boolean @default(true)
  ot_incomplete_inspection_report Boolean @default(true)

  // Admin defaults
  admin_new_user_registration        Boolean @default(true)
  admin_due_inspection               Boolean @default(true)
  admin_new_inspection_report_update Boolean @default(true)

  @@map("user_level_notification_settings")
}

// ─── 3. New singleton model: BrandingSettings ────────────────────────────────

model BrandingSettings {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  updated_by String?

  platform_name               String? @default("") @db.VarChar(100)
  platform_logo_url           String?
  signup_onboarding_image_url String?
  login_onboarding_image_url  String?
  primary_color               String? @db.VarChar(7)
  primary_color_label         String? @db.VarChar(50)

  @@map("branding_settings")
}

enum Role {
  ADMIN
  PROPERTY_MANAGER
  AUTHORIZED_VIEWER
  OPERATIONAL
}

enum UserStatus {
  ACTIVE
  DEACTIVATED
  DELETED
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum MediaType {
  PHOTO
  VIDEO
  PDF
  EMBED
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  ARCHIVED
}

enum TemplateStatus {
  ACTIVE
  INACTIVE
  DELETED
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}
